delimiter //
CREATE DEFINER=root@localhost PROCEDURE SP_Empleado_Listar()
BEGIN
    SELECT 
        Empl_Id,
        Empl_DNI,
        CONCAT(Empl_Nombre, ' ', Empl_Apellido) AS Empleado,
        Empl_Correo,
        CASE Empl_Sexo WHEN 'F' THEN 'Femenino' ELSE 'Masculino' END AS Empl_Sexo,
        Empl_FechaNac,
        M.Muni_Municipio,
        C.Esta_EstadoCivil,
        CA.Carg_Cargo,
        S.Sucu_Nombre
    FROM dbsistemaesmeralda.gral_tbempleados E
    LEFT JOIN gral_tbmunicipios M ON M.Muni_Codigo = E.Muni_Codigo
    LEFT JOIN gral_tbestadosciviles C ON C.Esta_Id = E.Esta_Id
    LEFT JOIN gral_tbcargos CA ON CA.Carg_Id = E.Carg_Id
    LEFT JOIN gral_tbsucursales S ON S.Sucu_Id = E.Sucu_Id
    WHERE Empl_Estado = 1;
END
//
delimiter ;

delimiter //
CREATE PROCEDURE SP_FacturaCompra_Listar()
BEGIN
    SELECT
		FaCE_Id,
		P.Prov_Proveedor as nombreProveedor,
		M.Mepa_Metodo as mepa_Metodo,
		FaCE_fechafinalizacion as faCE_fechafinalizacion,
		case FaCE_Finalizada when 0 then 'Si' ELSE 'No' END AS faCE_Finalizada
	FROM dbsistemaesmeralda.vent_tbfacturacompraencabezado fe LEFT JOIN gral_tbproveedores P
	ON P.Prov_Id = fe.Prov_Id left join gral_tbmetodospago M
	ON M.Mepa_Id = fe.Mepa_Id
	where FaCE_Etado = 1;
END
//
delimiter ;

delimiter //
CREATE DEFINER=root@localhost PROCEDURE SP_Usuario_Listar()
BEGIN
    SELECT
 Usua_Id, 
    Usua_Usuario, 
    Usua_Contrase単a, 
    CASE Usua_Administrador WHEN 1 THEN 'SI' ELSE 'NO' END AS Usua_Administradores, 
	R.Role_Rol,
    CONCAT(Empl_Nombre, ' ', Empl_Apellido) AS Empleado,
    Usua_UsuarioCreacion, 
    Usua_FechaCreacion, 
    Usua_UsuarioModificacion, 
    Usua_FechaModificacion, 
    Usua_Estado
  FROM dbsistemaesmeralda.acce_tbusuarios U
  LEFT JOIN acce_tbroles R ON R.Role_Id = U.Role_Id
  LEFT JOIN gral_tbempleados E ON E.Empl_Id = U.Empl_Id
  WHERE Usua_Estado = 1;
END
//
delimiter ;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Empleados_insertar`(
    IN `Empl_Nombre` NVARCHAR(30),
    IN `Empl_Apellido` NVARCHAR(30),
    IN `Empl_Sexo` CHAR(1),
    IN `Empl_FechaNac` DATETIME,
    IN `Empl_DNI` VARCHAR(13),
    IN `Muni_Codigo` VARCHAR(4),
    IN `Sucu_Id` INT,
    IN `Esta_Id` INT,
    IN `Carg_Id` INT,
    IN `Empl_Correo` VARCHAR(200),
    IN `Empl_UsuarioCreacion` INT,
    IN `Empl_FechaCreacion` DATETIME
)
BEGIN
    START TRANSACTION;
    BEGIN
        INSERT INTO `gral_tbempleados` (
            `Empl_Nombre`, 
            `Empl_Apellido`, 
            `Empl_Sexo`, 
            `Empl_FechaNac`,
            `Empl_DNI`,
            `Muni_Codigo`, 
            `Sucu_Id`,
            `Esta_Id`, 
            `Carg_Id`, 
            `Empl_Correo`,
            `Empl_Estado`, 
            `Empl_UsuarioCreacion`, 
            `Empl_FechaCreacion`
        ) VALUES (
            Empl_Nombre, 
            Empl_Apellido, 
            Empl_Sexo, 
            Empl_FechaNac, 
            Empl_DNI,
            Muni_Codigo,
            Sucu_Id,
            Esta_Id, 
            Carg_Id, 
            Empl_Correo,
            1,
            Empl_UsuarioCreacion, 
            Empl_FechaCreacion
        );
        COMMIT;
        SELECT 1 AS Resultado;
    END;
END;//
DELIMITER ;

ALTER TABLE dbsistemaesmeralda.acce_tbusuarios
MODIFY COLUMN Usua_Id INT AUTO_INCREMENT;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Usuario_insertar`(
    IN Usua_Usuario VARCHAR(30),
    IN Usua_Contrase単a VARCHAR(255),
    IN Usua_Administrador TINYINT(1),
    IN Empl_Id INT,
    IN Role_Id INT,
    IN Usua_UsuarioCreacion INT,
    IN Usua_FechaCreacion TIMESTAMP
)
BEGIN
    DECLARE estadoActual INT;

    -- Manejo de errores
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        SELECT 0;
    END;

    SELECT Usua_Estado INTO estadoActual FROM Acce_tbUsuarios WHERE Usua_Usuario = Usua_Usuario;

    IF estadoActual IS NOT NULL THEN
        IF estadoActual = 0 THEN
            UPDATE Acce_tbUsuarios SET Usua_Estado = 1 WHERE Usua_Usuario = Usua_Usuario;
            SELECT 1;
        ELSE
            SELECT 0;
        END IF;
    ELSE
        INSERT INTO Acce_tbUsuarios (
            Usua_Usuario,
            Usua_Contrase単a,
            Usua_Administrador,
            Empl_Id,
            Role_Id,
            Usua_Estado,
            Usua_UsuarioCreacion,
            Usua_FechaCreacion
        ) VALUES (
            Usua_Usuario,
            SHA2(Usua_Contrase単a, 512),
            Usua_Administrador,
            Empl_Id,
            Role_Id,
            1,
            Usua_UsuarioCreacion,
            Usua_FechaCreacion
        );
        SELECT 1;
    END IF;
END

DELIMITER ;

DELIMITER //

CREATE PROCEDURE sp_Municipios_MostrarPorDepartamento(
    IN Depa_Codigo VARCHAR(2)
)
BEGIN
    SELECT * FROM Gral_tbMunicipios
    WHERE Depa_Codigo = Depa_Codigo;
END //

DELIMITER ;

DELIMITER //

CREATE PROCEDURE sp_Departamentos_listar()
BEGIN
    SELECT 
        Depa_Codigo, 
        Depa_Departamento, 
        Depa_UsuarioCreacion, 
        Depa_FechaCreacion, 
        Depa_UsuarioModificacion,
        Depa_FechaModificacion
    FROM 
        Gral_tbDepartamentos;
END //

DELIMITER ;

DELIMITER //

CREATE PROCEDURE sp_Cargos_listar()
BEGIN
    SELECT 
        Carg_Id, 
        Carg_Cargo, 
        Carg_UsuarioCreacion, 
        Carg_FechaCreacion, 
        Carg_UsuarioModificacion, 
        Carg_FechaModificacion, 
        Carg_Estado
    FROM 
        Gral_tbCargos
    WHERE 
        Carg_Estado = 1;
END //

DELIMITER ;

DELIMITER //

CREATE PROCEDURE sp_Sucursales_listar()
BEGIN
    SELECT 
        Sucu_Id, 
        Sucu_Nombre, 
        s.Muni_Codigo, 
        m.Muni_Municipio,
        Sucu_UsuarioCreacion, 
        Sucu_FechaCreacion, 
        Sucu_UsuarioModificacion, 
        Sucu_FechaModificacion
    FROM 
        Gral_tbSucursales s 
        INNER JOIN Gral_tbMunicipios m ON s.Muni_Codigo = m.Muni_Codigo
    WHERE 
        Sucu_Estado = 1;
END //

DELIMITER ;

DELIMITER //

CREATE PROCEDURE sp_EstadosCiviles_listar()
BEGIN
    SELECT 
        Esta_Id, 
        Esta_EstadoCivil, 
        Esta_UsuarioCreacion, 
        Esta_FechaCreacion, 
        Esta_UsuarioModificacion, 
        Esta_FechaModificacion, 
        Esta_Estado
    FROM 
        Gral_tbEstadosCiviles
    WHERE 
        Esta_Estado = 1;
END //

DELIMITER ;

DELIMITER //

CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Municipios_MostrarPorDepartamento`(
    IN p_Depa_Codigo VARCHAR(2)
)
BEGIN
    SELECT * FROM Gral_tbMunicipios
    WHERE Depa_Codigo = p_Depa_Codigo;
END //

DELIMITER ;

ALTER TABLE dbsistemaesmeralda.gral_tbempleados
MODIFY COLUMN Empl_Id INT AUTO_INCREMENT;

ALTER TABLE dbsistemaesmeralda.acce_tbusuarios
MODIFY COLUMN Usua_Id INT AUTO_INCREMENT;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Empleados_Actualizar`(
    IN Empl_Id INT,
    IN Empl_Nombre NVARCHAR(30),
    IN Empl_Apellido NVARCHAR(30),
    IN Empl_Sexo CHAR(1),
    IN Empl_FechaNac DATETIME,
    IN Empl_DNI VARCHAR(13),
    IN Muni_Codigo VARCHAR(4),
    IN Sucu_Id INT,
    IN Esta_Id INT,
    IN Carg_Id INT,
    IN Empl_Correo VARCHAR(200),
    IN Empl_UsuarioModificacion INT,
    IN Empl_FechaModificacion DATETIME
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS Resultado;
    END;

    START TRANSACTION;
    UPDATE Gral_tbempleados
    SET
        Empl_Nombre = Empl_Nombre,
        Empl_Apellido = Empl_Apellido,
        Empl_Sexo = Empl_Sexo,
        Empl_FechaNac = Empl_FechaNac,
        Empl_DNI = Empl_DNI,
        Muni_Codigo = Muni_Codigo,
        Sucu_Id = Sucu_Id,
        Esta_Id = Esta_Id,
        Carg_Id = Carg_Id,
        Empl_Correo = Empl_Correo,
        Empl_UsuarioModificacion = Empl_UsuarioModificacion,
        Empl_FechaModificacion = Empl_FechaModificacion
    WHERE
        Empl_Id = Empl_Id;

    COMMIT;
    SELECT 1 AS Resultado;
END;
//
DELIMITER ;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Empleados_buscar`(
    IN Empl_Id INT
)
BEGIN
     SELECT 
        em.Empl_Id,
        em.Empl_Nombre,
        em.Empl_Apellido,
        em.Empl_Sexo,
        CASE Empl_Sexo WHEN 'F' THEN 'Femenino' ELSE 'Masculino' END Sexo,
        em.Empl_FechaNac,
        em.Muni_Codigo,
        em.Empl_DNI,
        em.Sucu_Id,
        su.Sucu_Nombre,
        mu.Muni_Municipio,
        em.Esta_Id,
        e.Esta_EstadoCivil,
        em.Carg_Id,
        c.Carg_Cargo,
        d.Depa_Codigo,
        d.Depa_Departamento,
        em.Empl_Correo,
        DATE_FORMAT(em.Empl_FechaCreacion, '%Y-%m-%d') AS FechaCreacion,
        DATE_FORMAT(em.Empl_FechaModificacion, '%Y-%m-%d') AS FechaModificacion,
        em.Empl_Estado,
        uCreacion.Usua_Usuario AS UsuarioCreacion,
        uModificador.Usua_Usuario AS UsuarioModificacion 
    FROM 
        Gral_tbempleados em 
    INNER JOIN 
        Gral_tbEstadosCiviles e ON em.Esta_Id = e.Esta_Id  
    INNER JOIN 
        Gral_tbCargos c ON em.Carg_Id = c.Carg_Id 
    INNER JOIN 
        Gral_tbMunicipios mu ON mu.Muni_Codigo = em.Muni_Codigo 
    LEFT JOIN 
        Acce_tbUsuarios uCreacion ON uCreacion.Usua_Id = em.Empl_UsuarioCreacion
    LEFT JOIN 
        Acce_tbUsuarios uModificador ON uModificador.Usua_Id = em.Empl_UsuarioModificacion
    LEFT JOIN 
        Gral_tbDepartamentos d ON d.Depa_Codigo = mu.Depa_Codigo
   LEFT JOIN  gral_tbsucursales su on su.sucu_Id = em.sucu_Id
    WHERE
        em.Empl_Id = Empl_Id;
END;
//
DELIMITER ;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Empleados_eliminar`(
    IN Empl_Id INT
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS Resultado;
    END;

    START TRANSACTION;
    UPDATE Gral_tbempleados
    SET Empl_Estado = 0
    WHERE Empl_Id = Empl_Id;

    COMMIT;
    SELECT 1 AS Resultado;
END;
//
DELIMITER ;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Usuarios_Actualizar`(
    IN p_Usua_Id INT,
    IN p_Usua_Usuario VARCHAR(30),
    IN p_Usua_Administrador TINYINT(1),
    IN p_Empl_Id INT,
    IN p_Role_Id INT,
    IN p_Usua_UsuarioModificacion INT,
    IN p_Usua_FechaModificacion DATETIME
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS Resultado;
    END;

    START TRANSACTION;
    UPDATE acce_tbusuarios
    SET
        Usua_Usuario = p_Usua_Usuario,
        Usua_Administrador = p_Usua_Administrador,
        Empl_Id = p_Empl_Id,
        Role_Id = p_Role_Id,
        Usua_UsuarioModificacion = p_Usua_UsuarioModificacion,
        Usua_FechaModificacion = p_Usua_FechaModificacion
    WHERE
        Usua_Id = p_Usua_Id;

    COMMIT;
    SELECT 1 AS Resultado;
END

//
DELIMITER ;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Usuarios_Eliminar`(
    IN p_Usua_Id INT
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 0 AS Resultado;
    END;

    START TRANSACTION;
    UPDATE Acce_tbUsuarios
    SET Usua_Estado = 0
    WHERE Usua_Id = p_Usua_Id;

    COMMIT;
    SELECT 1 AS Resultado;
END


//
DELIMITER ;
DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_Empleados_buscar`(
    IN Empl_Id INT
)
BEGIN
    SELECT 
        em.Empl_Id,
        em.Empl_Nombre,
        em.Empl_Apellido,
        em.Empl_Sexo,
        CASE Empl_Sexo WHEN 'F' THEN 'Femenino' ELSE 'Masculino' END Sexo,
        em.Empl_FechaNac,
        em.Muni_Codigo,
        em.Empl_DNI,
        em.Sucu_Id,
        su.Sucu_Nombre,
        mu.Muni_Municipio,
        em.Esta_Id,
        e.Esta_EstadoCivil,
        em.Carg_Id,
        c.Carg_Cargo,
        d.Depa_Codigo,
        d.Depa_Departamento,
        em.Empl_Correo,
        DATE_FORMAT(em.Empl_FechaCreacion, '%Y-%m-%d') AS FechaCreacion,
        DATE_FORMAT(em.Empl_FechaModificacion, '%Y-%m-%d') AS FechaModificacion,
        em.Empl_Estado,
        uCreacion.Usua_Usuario AS UsuarioCreacion,
        uModificador.Usua_Usuario AS UsuarioModificacion 
    FROM 
        Gral_tbempleados em 
    INNER JOIN 
        Gral_tbEstadosCiviles e ON em.Esta_Id = e.Esta_Id  
    INNER JOIN 
        Gral_tbCargos c ON em.Carg_Id = c.Carg_Id 
    INNER JOIN 
        Gral_tbMunicipios mu ON mu.Muni_Codigo = em.Muni_Codigo 
    LEFT JOIN 
        Acce_tbUsuarios uCreacion ON uCreacion.Usua_Id = em.Empl_UsuarioCreacion
    LEFT JOIN 
        Acce_tbUsuarios uModificador ON uModificador.Usua_Id = em.Empl_UsuarioModificacion
    LEFT JOIN 
        Gral_tbDepartamentos d ON d.Depa_Codigo = mu.Depa_Codigo
   LEFT JOIN  gral_tbsucursales su on su.sucu_Id = em.sucu_Id
    WHERE
        em.Empl_Id = Empl_Id;
END


//
DELIMITER ;
